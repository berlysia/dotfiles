{{ if ne .chezmoi.os "windows" -}}
#!/bin/bash
# Install Chromium for agent-browser
# Config hash: {{ include "dot_config/mise/config.toml" | sha256sum }}

set -euo pipefail

log() {
    local level="${2:-INFO}"
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [$level] $1"
}

# Initialize mise environment to access agent-browser
log "Initializing mise environment..."
if command -v mise &> /dev/null; then
    if mise_env=$(mise env --shell bash 2>/dev/null); then
        eval "$mise_env"
        log "Initialized mise environment for current session"
    else
        log "Failed to initialize mise environment" "WARNING"
    fi
else
    log "mise not found. Skipping environment initialization." "WARNING"
fi

# Check if agent-browser is available
if ! command -v agent-browser &> /dev/null; then
    log "agent-browser not found. Skipping browser installation." "WARNING"
    log "Run 'mise install' to install agent-browser first." "INFO"
    exit 0
fi

log "agent-browser is available"

# Check if Chromium is already installed
PLAYWRIGHT_CACHE="$HOME/.cache/ms-playwright"
if [ -d "$PLAYWRIGHT_CACHE" ] && [ -n "$(find "$PLAYWRIGHT_CACHE" -maxdepth 1 -name "chromium-*" -type d 2>/dev/null)" ]; then
    log "Chromium is already installed in $PLAYWRIGHT_CACHE" "SUCCESS"
    log "Skipping browser installation (idempotent check)" "INFO"
    exit 0
fi

log "Chromium not found. Installing browser for agent-browser..."

# Install Chromium with system dependencies on Linux
if [ "{{ .chezmoi.os }}" = "linux" ]; then
    log "Detected Linux. Installing with system dependencies (--with-deps)..."
    if agent-browser install --with-deps 2>&1; then
        log "Successfully installed Chromium with dependencies" "SUCCESS"
    else
        log "Installation with --with-deps failed. Trying without deps..." "WARNING"
        if agent-browser install 2>&1; then
            log "Successfully installed Chromium (without system deps)" "SUCCESS"
        else
            log "Failed to install Chromium. Please install manually with 'agent-browser install'" "ERROR"
            exit 1
        fi
    fi
else
    # macOS and other Unix-like systems
    log "Installing browser for {{ .chezmoi.os }}..."
    if agent-browser install 2>&1; then
        log "Successfully installed Chromium" "SUCCESS"
    else
        log "Failed to install Chromium. Please install manually with 'agent-browser install'" "WARNING"
        exit 0
    fi
fi

log "Browser installation completed"
{{ end -}}
