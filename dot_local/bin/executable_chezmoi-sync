#!/bin/bash
# chezmoi-sync - 実ファイル同期のラッパーコマンド

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SYNC_SCRIPT="${HOME}/.local/share/chezmoi/scripts/sync-from-home.sh"
STATUS_SCRIPT="${HOME}/.local/share/chezmoi/scripts/sync-status.sh"

# ヘルプメッセージ
show_help() {
    cat << EOF
chezmoi-sync - 実ファイル変更の取り込み管理

使用法:
  chezmoi-sync [command] [options]

コマンド:
  sync [auto|interactive]  実ファイルの変更を取り込み
    auto         自動取り込み（デフォルト）
    interactive  インタラクティブ取り込み
  
  status [option]          同期状況の確認
    status       全体状況（デフォルト）
    changes      変更状況のみ
    logs         ログのみ
    backups      バックアップ状況のみ
    config       設定状況のみ
    stats        統計情報のみ
  
  detect                   変更検出のみ
  
  config                   設定ファイルを編集
  
  help                     このヘルプを表示

例:
  chezmoi-sync                    # 自動取り込み
  chezmoi-sync sync interactive   # インタラクティブ取り込み
  chezmoi-sync status             # 状況確認
  chezmoi-sync status changes     # 変更状況のみ確認
  chezmoi-sync detect             # 変更検出のみ
EOF
}

# 設定ファイル編集
edit_config() {
    local config_file="${HOME}/.local/share/chezmoi/scripts/sync-config.json"
    
    if [ -n "${EDITOR:-}" ]; then
        "${EDITOR}" "${config_file}"
    elif command -v code >/dev/null 2>&1; then
        code "${config_file}"
    elif command -v nano >/dev/null 2>&1; then
        nano "${config_file}"
    else
        echo "Error: エディタが見つかりません。EDITOR環境変数を設定してください。"
        exit 1
    fi
}

# メイン処理
main() {
    local command="${1:-sync}"
    
    case "${command}" in
        sync|s)
            shift
            if [ -x "${SYNC_SCRIPT}" ]; then
                "${SYNC_SCRIPT}" "${1:-auto}"
            else
                echo "Error: Sync script not found: ${SYNC_SCRIPT}"
                exit 1
            fi
            ;;
        status|st)
            shift
            if [ -x "${STATUS_SCRIPT}" ]; then
                "${STATUS_SCRIPT}" "${1:-status}"
            else
                echo "Error: Status script not found: ${STATUS_SCRIPT}"
                exit 1
            fi
            ;;
        detect|d)
            if [ -x "${SYNC_SCRIPT}" ]; then
                "${SYNC_SCRIPT}" detect
            else
                echo "Error: Sync script not found: ${SYNC_SCRIPT}"
                exit 1
            fi
            ;;
        config|c)
            edit_config
            ;;
        help|h|-h|--help)
            show_help
            ;;
        *)
            echo "Error: Unknown command: ${command}"
            echo "Run 'chezmoi-sync help' for usage information."
            exit 1
            ;;
    esac
}

# スクリプト実行チェック
if [ "${BASH_SOURCE[0]}" = "${0}" ]; then
    main "$@"
fi