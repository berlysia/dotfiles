#!/usr/bin/env bash

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Help function
show_help() {
    cat <<'EOF'
git-worktree-cleanup - Interactively clean up git worktrees

Usage:
  git-worktree-cleanup
  git-worktree-cleanup --help

Description:
  Interactively checks and removes completed git worktrees. The command
  performs the following checks for each worktree:

  Safety checks (automatically skips):
  - Has uncommitted changes
  - Has unpushed commits (local ahead of remote)

  Interactive checks (prompts for confirmation):
  - Branch not merged into main branch
  - Has stashed changes

  Automatic removal criteria:
  - No uncommitted changes
  - No unpushed commits
  - Branch is merged into main, or user confirms deletion
  - No stashes, or user confirms deletion

Options:
  --help, -h     Show this help message

Examples:
  # Clean up all completed worktrees interactively
  git-worktree-cleanup

Note:
  - Main worktree is always skipped
  - Prunes worktree list after successful deletions
  - Safe by default - preserves work-in-progress worktrees
EOF
}

# Check for help flag
if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]] || [[ "${1:-}" == "help" ]]; then
    show_help
    exit 0
fi

echo "ðŸ” Checking git worktrees..."

# Get main branch (usually main or master)
main_branch=$(git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@^refs/remotes/origin/@@' || echo "main")

# Get list of worktrees
worktrees=$(git worktree list --porcelain | grep "^worktree " | cut -d' ' -f2-)

# Track if any worktrees were deleted
deleted_any=false

for worktree in $worktrees; do
    # Skip main worktree
    if [[ "$worktree" == "$(git rev-parse --show-toplevel)" ]]; then
        continue
    fi
    
    # Check if directory exists
    if [[ ! -d "$worktree" ]]; then
        echo -e "${YELLOW}âš ï¸  Worktree directory not found: $worktree${NC}"
        continue
    fi
    
    echo -e "\nðŸ“ Checking worktree: $worktree"
    
    # Enter worktree directory
    cd "$worktree" || continue
    
    # Get current branch
    branch=$(git branch --show-current)
    
    # Check for uncommitted changes
    if [[ -n $(git status --porcelain) ]]; then
        echo -e "${RED}âœ— Has uncommitted changes - skipping${NC}"
        continue
    fi
    
    # Check if branch exists on remote
    if ! git ls-remote --exit-code --heads origin "$branch" &>/dev/null; then
        echo -e "${GREEN}âœ“ Branch not on remote${NC}"
    else
        # Check if local branch is behind or ahead of remote
        ahead=$(git rev-list --count "origin/$branch".."$branch" 2>/dev/null || echo "0")
        behind=$(git rev-list --count "$branch".."origin/$branch" 2>/dev/null || echo "0")
        
        if [[ "$ahead" -gt 0 ]]; then
            echo -e "${RED}âœ— Local branch is ahead of remote by $ahead commits - skipping${NC}"
            continue
        fi
        
        if [[ "$behind" -gt 0 ]]; then
            echo -e "${YELLOW}âš ï¸  Local branch is behind remote by $behind commits${NC}"
        fi
        
        # Check if branch is merged into main
        if git merge-base --is-ancestor "$branch" "origin/$main_branch" 2>/dev/null; then
            echo -e "${GREEN}âœ“ Branch is merged into $main_branch${NC}"
        else
            echo -e "${YELLOW}âš ï¸  Branch is not merged into $main_branch${NC}"
            read -p "Delete anyway? (y/N) " -n 1 -r
            echo
            if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                continue
            fi
        fi
    fi
    
    # Check for stashes
    stash_count=$(git stash list | wc -l)
    if [[ "$stash_count" -gt 0 ]]; then
        echo -e "${YELLOW}âš ï¸  Has $stash_count stashes${NC}"
        read -p "Delete anyway? (y/N) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            continue
        fi
    fi
    
    # Return to original directory before deletion
    cd - >/dev/null
    
    # Delete worktree
    echo -e "${GREEN}âœ“ Removing worktree: $worktree${NC}"
    git worktree remove "$worktree" --force
    deleted_any=true
done

# Prune worktree list if any were deleted
if [[ "$deleted_any" == true ]]; then
    echo -e "\nðŸ§¹ Pruning worktree list..."
    git worktree prune
    echo -e "${GREEN}âœ“ Done!${NC}"
else
    echo -e "\n${YELLOW}No worktrees were deleted.${NC}"
fi