#!/usr/bin/env bash

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Help function
show_help() {
    cat <<'EOF'
git-worktree-create - Create a new git worktree in .git/worktree directory

Usage:
  git-worktree-create <branch-name>
  git-worktree-create --help

Description:
  Creates a new git worktree in the .git/worktree directory. The command
  intelligently handles different scenarios:

  - If branch exists locally: Creates worktree from local branch
  - If branch exists on remote: Creates local tracking branch and worktree
  - If branch doesn't exist: Creates new branch from current HEAD

Arguments:
  <branch-name>  Name of the branch for the worktree

Options:
  --help, -h     Show this help message

Examples:
  # Create worktree for existing branch
  git-worktree-create feature-login

  # Create worktree for new branch
  git-worktree-create new-feature

  # Create worktree from remote branch
  git-worktree-create origin-feature

Location:
  Worktrees are created in: <repo-root>/.git/worktree/<branch-name>
EOF
}

# Check for help flag
if [[ $# -eq 0 ]] || [[ "$1" == "--help" ]] || [[ "$1" == "-h" ]] || [[ "$1" == "help" ]]; then
    if [[ $# -eq 0 ]]; then
        echo -e "${RED}Error: Branch name is required${NC}\n"
    fi
    show_help
    exit $([ $# -eq 0 ] && echo 1 || echo 0)
fi

branch_name="$1"

# Get repository root
repo_root=$(git rev-parse --show-toplevel)
worktrees_dir="$repo_root/.git/worktree"

# Create .git/worktree directory if it doesn't exist
if [[ ! -d "$worktrees_dir" ]]; then
    echo -e "${BLUE}üìÅ Creating .git/worktree directory...${NC}"
    mkdir -p "$worktrees_dir"
fi

# Set worktree path
worktree_path="$worktrees_dir/$branch_name"

# Check if worktree already exists
if [[ -d "$worktree_path" ]]; then
    echo -e "${RED}‚úó Worktree already exists: $worktree_path${NC}"
    exit 1
fi

# Check if branch exists locally
if git show-ref --verify --quiet "refs/heads/$branch_name"; then
    echo -e "${GREEN}‚úì Branch '$branch_name' exists locally${NC}"
    git worktree add "$worktree_path" "$branch_name"
elif git show-ref --verify --quiet "refs/remotes/origin/$branch_name"; then
    # Branch exists on remote but not locally
    echo -e "${YELLOW}‚ö†Ô∏è  Branch '$branch_name' exists on remote, creating local tracking branch${NC}"
    git worktree add "$worktree_path" -b "$branch_name" "origin/$branch_name"
else
    # Branch doesn't exist, create new branch from current
    current_branch=$(git branch --show-current)
    echo -e "${BLUE}üìù Creating new branch '$branch_name' from '$current_branch'${NC}"
    git worktree add "$worktree_path" -b "$branch_name"
fi

echo -e "${GREEN}‚úì Worktree created: $worktree_path${NC}"
echo -e "${BLUE}üí° To switch to this worktree: cd $worktree_path${NC}"