{{ if eq .chezmoi.os "windows" -}}
# Install mise and packages on Windows

$ErrorActionPreference = "Stop"

function Write-Log {
    param([string]$Message, [string]$Level = "INFO")
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    Write-Host "[$timestamp] [$Level] $Message"
}

# Check if mise is available
$miseFound = $false
$misePaths = @(
    "mise",
    "$env:LOCALAPPDATA\Microsoft\WinGet\Packages\jdx.mise_Microsoft.Winget.Source_*\mise.exe",
    "$env:USERPROFILE\.local\bin\mise.exe",
    "$env:ProgramFiles\mise\mise.exe"
)

foreach ($misePath in $misePaths) {
    try {
        if ($misePath -eq "mise") {
            # Try system PATH first
            $null = & mise --version 2>$null
            if ($LASTEXITCODE -eq 0) {
                Write-Log "mise found in PATH"
                $miseFound = $true
                break
            }
        } else {
            # Expand wildcards for WinGet path
            if ($misePath -like "*`**") {
                $expandedPaths = Get-ChildItem -Path ($misePath -replace '\*.*$', '') -Filter "mise.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -ExpandProperty FullName
                foreach ($expandedPath in $expandedPaths) {
                    if (Test-Path $expandedPath) {
                        $null = & $expandedPath --version 2>$null
                        if ($LASTEXITCODE -eq 0) {
                            Write-Log "mise found at: $expandedPath"
                            # Add directory to PATH for this session
                            $miseDir = Split-Path $expandedPath
                            $env:PATH = "$miseDir;$env:PATH"
                            $miseFound = $true
                            break
                        }
                    }
                }
            } else {
                if (Test-Path $misePath) {
                    $null = & $misePath --version 2>$null
                    if ($LASTEXITCODE -eq 0) {
                        Write-Log "mise found at: $misePath"
                        # Add directory to PATH for this session
                        $miseDir = Split-Path $misePath
                        $env:PATH = "$miseDir;$env:PATH"
                        $miseFound = $true
                        break
                    }
                }
            }
        }
        if ($miseFound) { break }
    } catch {
        # Continue to next path
        continue
    }
}

if (-not $miseFound) {
    Write-Log "mise not found in any expected locations. Please ensure winget packages are installed and mise is in PATH." "ERROR"
    Write-Log "Searched locations: $($misePaths -join ', ')" "ERROR"
    exit 1
}

# Disable GPG verification for automated installation
$env:MISE_NODE_VERIFY = "false"
$env:MISE_PYTHON_VERIFY = "false"

# Install mise packages
$packages = @(
{{- range $index, $package := .packages.mise }}
    "{{ $package }}"{{ if ne $index (sub (len $.packages.mise) 1) }},{{ end }}
{{- end }}
)

foreach ($package in $packages) {
    Write-Log "Processing package: $package"
    
    try {
        # Get latest version
        $version = & mise latest $package 2>$null
        if ($LASTEXITCODE -ne 0) {
            Write-Log "Could not get latest version for $package" "WARNING"
            continue
        }
        
        # Check if already installed
        $installed = & mise ls $package 2>$null
        if ($LASTEXITCODE -eq 0 -and $installed -match $version) {
            Write-Log "${package}@${version} already installed"
            # Ensure it's set as global even if already installed
            & mise use --global "${package}@${version}"
        } else {
            # Install package
            Write-Log "Installing ${package}@${version}..."
            & mise install $package $version
            if ($LASTEXITCODE -eq 0) {
                # Set as global version
                & mise use --global "${package}@${version}"
                if ($LASTEXITCODE -eq 0) {
                    Write-Log "Successfully installed and activated ${package}@${version}" "SUCCESS"
                } else {
                    Write-Log "Installed ${package}@${version} but failed to set as global" "WARNING"
                }
            } else {
                Write-Log "Failed to install ${package}@${version}" "ERROR"
                continue
            }
        }
    } catch {
        Write-Log "Error processing $package`: $($_.Exception.Message)" "ERROR"
    }
}

Write-Log "mise package installation completed"

# Setup environment in current session for immediate use
Write-Log "Setting up environment in current session..."

# Add user local bin to PATH if not already present
$localBin = "$env:USERPROFILE\.local\bin"
if (Test-Path $localBin) {
    $currentPath = $env:PATH
    if ($currentPath -notlike "*$localBin*") {
        $env:PATH = "$localBin;$currentPath"
        Write-Log "Added $localBin to PATH"
    }
}

# Initialize mise environment
try {
    $miseEnv = & mise env --shell powershell 2>$null
    if ($LASTEXITCODE -eq 0 -and $miseEnv) {
        Invoke-Expression $miseEnv
        Write-Log "Initialized mise environment for current session"
    }
} catch {
    Write-Log "Failed to initialize mise environment" "WARNING"
}

# Set up Go environment variables
if (Get-Command go -ErrorAction SilentlyContinue) {
    if (-not $env:GOPATH) {
        $env:GOPATH = "$env:USERPROFILE\go"
        Write-Log "Set GOPATH to $env:GOPATH"
    }
    $goBin = "$env:GOPATH\bin"
    if ((Test-Path $goBin) -and ($env:PATH -notlike "*$goBin*")) {
        $env:PATH = "$goBin;$env:PATH"
        Write-Log "Added $goBin to PATH"
    }
}

# Set up Rust environment
$cargoEnv = "$env:USERPROFILE\.cargo\env.ps1"
if (Test-Path $cargoEnv) {
    & $cargoEnv
    Write-Log "Loaded Rust/Cargo environment"
}

Write-Log "Environment setup completed - tools are now available in current session"
{{ end -}}