#!/usr/bin/env bash
# Search ~/.claude/tasks/ for a task list whose first task matches the given subject.
# Usage: claude-task-list-id "<subject>"
# Output: directory name (task list ID) on stdout

set -euo pipefail

if [[ $# -ne 1 ]] || [[ -z "$1" ]]; then
  echo "Usage: claude-task-list-id <subject>" >&2
  exit 1
fi

TARGET_SUBJECT="$1"
TASKS_DIR="${HOME}/.claude/tasks"

if [[ ! -d "${TASKS_DIR}" ]]; then
  echo "Error: ${TASKS_DIR} does not exist" >&2
  exit 1
fi

# Sort by modification time (newest first) using stat + sort
while IFS= read -r task_file; do
  dir=$(basename "$(dirname "${task_file}")")
  # 2>/dev/null: skip parse errors from concurrent writes
  subject=$(jq -r '.subject' "${task_file}" 2>/dev/null) || continue
  if [[ "${subject}" = "${TARGET_SUBJECT}" ]]; then
    echo "${dir}"
    exit 0
  fi
done < <(find "${TASKS_DIR}" -maxdepth 2 -name '1.json' -print0 | xargs -0 stat -f '%m %N' | sort -rn | cut -d' ' -f2-)

echo "Error: no task list found matching subject: ${TARGET_SUBJECT}" >&2
exit 1
