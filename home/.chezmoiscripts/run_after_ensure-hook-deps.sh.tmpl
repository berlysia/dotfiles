{{ if ne .chezmoi.os "windows" -}}
#!/bin/bash
# Safety net: ensure hook dependencies exist at ~/.claude/
# This runs on every chezmoi apply, but only triggers bun install
# when node_modules is missing (e.g., after a failed run_onchange install)

CLAUDE_DIR="$HOME/.claude"

if [ ! -f "$CLAUDE_DIR/package.json" ] || [ -d "$CLAUDE_DIR/node_modules" ]; then
    exit 0
fi

# node_modules missing â€” likely a previous install failure
echo "[$(date '+%Y-%m-%d %H:%M:%S')] [WARNING] Hook node_modules missing at $CLAUDE_DIR, installing..."

# Initialize mise environment to access bun
if command -v mise &> /dev/null; then
    if mise_env=$(mise env --shell bash 2>/dev/null); then
        eval "$mise_env"
    fi
fi

if ! command -v bun &> /dev/null; then
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [WARNING] bun not found, cannot install hook deps"
    exit 0
fi

if (cd "$CLAUDE_DIR" && bun install 2>&1); then
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [SUCCESS] Recovered hook dependencies"
else
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [ERROR] Failed to recover hook dependencies"
    exit 1
fi
{{ end -}}
