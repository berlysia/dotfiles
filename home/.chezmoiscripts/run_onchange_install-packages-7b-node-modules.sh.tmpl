{{ if ne .chezmoi.os "windows" -}}
#!/bin/bash
# Install node_modules for chezmoi source directory (hooks, skills, etc.)
# package.json hash: {{ output "cat" (joinPath .chezmoi.workingTree "package.json") | sha256sum }}
# pnpm-lock.yaml hash: {{ output "cat" (joinPath .chezmoi.workingTree "pnpm-lock.yaml") | sha256sum }}
# hook package.json hash: {{ output "cat" (joinPath .chezmoi.workingTree "home/dot_claude/package.json") | sha256sum }}
# hook bun.lock hash: {{ output "cat" (joinPath .chezmoi.workingTree "home/dot_claude/bun.lock") | sha256sum }}

set -euo pipefail

log() {
    local level="${2:-INFO}"
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [$level] $1"
}

SOURCE_DIR="{{ .chezmoi.workingTree }}"
CLAUDE_DIR="$HOME/.claude"

# Initialize mise environment to access pnpm
if command -v mise &> /dev/null; then
    if mise_env=$(mise env --shell bash 2>/dev/null); then
        eval "$mise_env"
    fi
fi

# Check if pnpm is available
if ! command -v pnpm &> /dev/null; then
    log "pnpm not found. Skipping node_modules install." "WARNING"
    log "Run 'mise install' to install node first." "INFO"
    exit 0
fi

log "Installing node_modules in $SOURCE_DIR..."
if (cd "$SOURCE_DIR" && pnpm install --frozen-lockfile 2>&1); then
    log "Successfully installed node_modules" "SUCCESS"
else
    log "frozen-lockfile failed, trying regular install..." "WARNING"
    if (cd "$SOURCE_DIR" && pnpm install 2>&1); then
        log "Successfully installed node_modules" "SUCCESS"
    else
        log "Failed to install node_modules" "ERROR"
        exit 1
    fi
fi

# Install hook dependencies at ~/.claude/ so bun can resolve them
# bun resolves modules by walking up from the script location (~/.claude/hooks/)
if [ -f "$CLAUDE_DIR/package.json" ] && command -v bun &> /dev/null; then
    log "Installing hook dependencies in $CLAUDE_DIR..."
    if (cd "$CLAUDE_DIR" && bun install 2>&1); then
        log "Successfully installed hook dependencies" "SUCCESS"
    else
        log "Failed to install hook dependencies" "ERROR"
        exit 1
    fi
fi

log "node_modules installation completed"
{{ end -}}
