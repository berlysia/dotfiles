{{- /* Template content */ -}}
{{- $templateContent := include "dot_codex/.config.toml" -}}
{{- $targetFile := joinPath .chezmoi.homeDir ".codex" "config.toml" -}}

{{- /* Check if target file exists */ -}}
{{- if stat $targetFile -}}
  {{- /* Target file exists, smart merge with existing user settings */ -}}
  {{- /* Strategy: template as base, user settings override, mcp_servers forced from template */ -}}
  {{- $mergeScript := `
set -euo pipefail

TARGET_FILE="$1"
TEMPLATE_CONTENT="$2"
TEMP_TEMPLATE=$(mktemp)
trap 'rm -f "$TEMP_TEMPLATE"' EXIT

echo "$TEMPLATE_CONTENT" > "$TEMP_TEMPLATE"

# Check if mise and dasel are available
if ! command -v mise &>/dev/null || ! mise list dasel &>/dev/null 2>&1; then
    cat "$TEMP_TEMPLATE"
    exit 0
fi

# Check if target file is valid TOML
if ! cat "$TARGET_FILE" | mise x -- dasel query --root -i toml -o json >/dev/null 2>&1; then
    cat "$TEMP_TEMPLATE"
    exit 0
fi

# Convert both to JSON
EXISTING_JSON=$(cat "$TARGET_FILE" | mise x -- dasel query --root -i toml -o json 2>/dev/null)
TEMPLATE_JSON=$(cat "$TEMP_TEMPLATE" | mise x -- dasel query --root -i toml -o json 2>/dev/null)

if [ $? -ne 0 ]; then
    cat "$TEMP_TEMPLATE"
    exit 0
fi

# Merge: template as base, user settings override, then force template-managed keys
# - User keys (model, model_reasoning_effort, projects, etc.) are preserved
# - mcp_servers always comes from template (managed infrastructure)
# - Deprecated keys (features) are removed
echo "$TEMPLATE_JSON" | jq \
  --argjson existing "$EXISTING_JSON" \
  '. as $template | (. * ($existing | del(.mcp_servers) | del(.features))) | .mcp_servers = $template.mcp_servers' \
  | mise x -- dasel query --root -i json -o toml
` -}}
  {{- output "bash" "-c" $mergeScript "--" $targetFile $templateContent -}}
{{- else -}}
  {{- /* Target file doesn't exist, output template as-is */ -}}
  {{- $templateContent -}}
{{- end -}}
