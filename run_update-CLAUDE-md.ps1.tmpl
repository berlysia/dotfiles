{{ if eq .chezmoi.os "windows" -}}
# Update ~/.claude/CLAUDE.md when chezmoi template changes
# Hash: {{ includeTemplate "dot_claude/.CLAUDE.md" . | sha256sum }}

$ErrorActionPreference = "Stop"

$TargetFile = "$env:USERPROFILE\.claude\CLAUDE.md"
$TempFile = [System.IO.Path]::GetTempFileName()

# Generate new content from chezmoi template
@'
{{ includeTemplate "dot_claude/.CLAUDE.md" . }}
'@ | Out-File -FilePath $TempFile -Encoding UTF8

try {
    # Create directory if it doesn't exist
    $TargetDir = Split-Path $TargetFile -Parent
    if (!(Test-Path $TargetDir)) {
        New-Item -ItemType Directory -Path $TargetDir -Force | Out-Null
    }

    # Check if file exists and compare
    if (Test-Path $TargetFile) {
        $existingContent = Get-Content $TargetFile -Raw -ErrorAction SilentlyContinue
        $newContent = Get-Content $TempFile -Raw
        
        if ($existingContent -eq $newContent) {
            Write-Host "No changes to CLAUDE.md"
            exit 0
        }
        Write-Host "Updating CLAUDE.md..."
    } else {
        Write-Host "Creating new CLAUDE.md..."
    }

    # Update file
    Copy-Item $TempFile $TargetFile
    Write-Host "CLAUDE.md updated successfully"

} finally {
    # Cleanup
    Remove-Item $TempFile -ErrorAction SilentlyContinue
}
{{ end -}}