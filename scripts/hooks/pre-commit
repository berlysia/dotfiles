#!/bin/bash
# Git pre-commit hook
# - Secret detection with gitleaks
# - Hook tests when hook files are modified

set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Skip if requested
if [ "${SKIP_HOOKS:-}" = "1" ]; then
    echo -e "${YELLOW}‚ö† Hooks skipped (SKIP_HOOKS=1)${NC}"
    exit 0
fi

REPO_ROOT=$(git rev-parse --show-toplevel)
EXIT_CODE=0

#
# 1. Secret Detection (gitleaks)
#
echo -e "${BLUE}üîç Checking for secrets...${NC}"
if command -v gitleaks &> /dev/null; then
    if ! gitleaks protect --staged --config "${REPO_ROOT}/.gitleaks.toml" --verbose; then
        echo -e "${RED}‚ùå Secrets detected! Remove them before committing.${NC}"
        echo -e "${YELLOW}   If false positive: update .gitleaks.toml or .gitleaksignore${NC}"
        EXIT_CODE=1
    else
        echo -e "${GREEN}‚úì No secrets found${NC}"
    fi
else
    echo -e "${YELLOW}‚ö† gitleaks not installed, skipping secret detection${NC}"
    echo -e "${YELLOW}  Install: mise install gitleaks${NC}"
fi

echo

#
# 2. TypeScript/JavaScript Linting (biome)
#
STAGED_TS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx|json)$' || true)
if [ -n "$STAGED_TS_FILES" ]; then
    echo -e "${BLUE}ü¶ã Checking TypeScript/JavaScript with biome...${NC}"
    if command -v biome &> /dev/null; then
        if ! biome check --write --staged --files-ignore-unknown=true; then
            echo -e "${RED}‚ùå biome found unfixable issues in staged files${NC}"
            EXIT_CODE=1
        else
            # Re-stage files that biome may have formatted
            for file in $STAGED_TS_FILES; do
                if [ -f "$file" ]; then
                    git add "$file"
                fi
            done
            echo -e "${GREEN}‚úì All staged files passed biome checks${NC}"
        fi
    else
        echo -e "${YELLOW}‚ö† biome not installed, skipping${NC}"
        echo -e "${YELLOW}  Install: pnpm install${NC}"
    fi
else
    echo -e "${GREEN}‚úì No TypeScript/JavaScript files staged${NC}"
fi

echo

#
# 3. Shell Script Linting (shellcheck)
#
STAGED_SH_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.sh' || true)
# Also check staged executable scripts without .sh extension (e.g., executable_*)
STAGED_EXEC_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '(^|/)executable_' || true)
ALL_SHELL_FILES=$(echo -e "${STAGED_SH_FILES}\n${STAGED_EXEC_FILES}" | sort -u | grep -v '^$' || true)
if [ -n "$ALL_SHELL_FILES" ]; then
    echo -e "${BLUE}üêö Checking shell scripts with shellcheck...${NC}"
    if command -v shellcheck &> /dev/null; then
        SHELLCHECK_FAILED=false
        for file in $ALL_SHELL_FILES; do
            if [ -f "$file" ]; then
                echo "  Checking: $file"
                if ! shellcheck --severity=warning "$file"; then
                    SHELLCHECK_FAILED=true
                fi
            fi
        done

        if [ "$SHELLCHECK_FAILED" = true ]; then
            echo -e "${RED}‚ùå shellcheck found issues in staged files${NC}"
            EXIT_CODE=1
        else
            echo -e "${GREEN}‚úì All staged shell scripts passed shellcheck${NC}"
        fi
    else
        echo -e "${YELLOW}‚ö† shellcheck not installed, skipping${NC}"
        echo -e "${YELLOW}  Install: apt install shellcheck${NC}"
    fi
else
    echo -e "${GREEN}‚úì No shell scripts staged${NC}"
fi

echo

#
# 4. Codex Config Format Check
#
STAGED_CODEX_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E 'dot_codex/config\.toml|scripts/(check|format)-codex-config\.sh' || true)
if [ -n "$STAGED_CODEX_FILES" ]; then
    echo -e "${BLUE}‚öôÔ∏è  Checking Codex config format...${NC}"
    CHECK_SCRIPT="${REPO_ROOT}/scripts/check-codex-config.sh"

    if [ -f "$CHECK_SCRIPT" ]; then
        if [ -f "${REPO_ROOT}/dot_codex/config.toml" ]; then
            if "$CHECK_SCRIPT"; then
                echo -e "${GREEN}‚úì Codex config is properly formatted${NC}"
            else
                echo -e "${RED}‚ùå Codex config needs formatting${NC}"
                echo -e "${YELLOW}  Run: ./scripts/format-codex-config.sh${NC}"
                EXIT_CODE=1
            fi
        else
            echo -e "${YELLOW}‚ö† dot_codex/config.toml not found, skipping${NC}"
        fi
    else
        echo -e "${YELLOW}‚ö† Check script not found, skipping${NC}"
    fi
else
    echo -e "${GREEN}‚úì No Codex config files staged${NC}"
fi

echo

#
# 5. Hook Tests (existing functionality)
#
HOOKS_SCRIPTS_DIR="${REPO_ROOT}/dot_claude/hooks/scripts"
STAGED_FILES=$(git diff --cached --name-only)

HOOK_FILES_MODIFIED=false
for file in $STAGED_FILES; do
    case "$file" in
        *claude/hooks/*)
            HOOK_FILES_MODIFIED=true
            break
            ;;
    esac
done

if [ "$HOOK_FILES_MODIFIED" = true ] || [ "${FORCE_HOOK_TESTS:-}" = "1" ]; then
    echo -e "${BLUE}üß™ Running hook tests...${NC}"

    FAST_TEST="${HOOKS_SCRIPTS_DIR}/test_fast.sh"
    FULL_TEST="${HOOKS_SCRIPTS_DIR}/run_all_tests.sh"

    if [ -f "$FAST_TEST" ]; then
        TEST_RUNNER="$FAST_TEST"
    elif [ -f "$FULL_TEST" ]; then
        TEST_RUNNER="$FULL_TEST"
    else
        echo -e "${YELLOW}‚ö† No test runner found, skipping${NC}"
        TEST_RUNNER=""
    fi

    if [ -n "$TEST_RUNNER" ]; then
        cd "$HOOKS_SCRIPTS_DIR"
        if ! "$TEST_RUNNER"; then
            echo -e "${RED}‚ùå Hook tests failed!${NC}"
            EXIT_CODE=1
        else
            echo -e "${GREEN}‚úì Hook tests passed${NC}"
        fi
    fi
else
    echo -e "${GREEN}‚úì No hook files modified, skipping tests${NC}"
fi

exit $EXIT_CODE
