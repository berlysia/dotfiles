#!/bin/bash
# Git pre-commit hook
# - Secret detection with gitleaks
# - Hook tests when hook files are modified

set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Skip if requested
if [ "${SKIP_HOOKS:-}" = "1" ]; then
    echo -e "${YELLOW}‚ö† Hooks skipped (SKIP_HOOKS=1)${NC}"
    exit 0
fi

REPO_ROOT=$(git rev-parse --show-toplevel)
EXIT_CODE=0

#
# 1. Secret Detection (gitleaks)
#
echo -e "${BLUE}üîç Checking for secrets...${NC}"
if command -v gitleaks &> /dev/null; then
    if ! gitleaks protect --staged --config "${REPO_ROOT}/.gitleaks.toml" --verbose; then
        echo -e "${RED}‚ùå Secrets detected! Remove them before committing.${NC}"
        echo -e "${YELLOW}   If false positive: update .gitleaks.toml or .gitleaksignore${NC}"
        EXIT_CODE=1
    else
        echo -e "${GREEN}‚úì No secrets found${NC}"
    fi
else
    echo -e "${YELLOW}‚ö† gitleaks not installed, skipping secret detection${NC}"
    echo -e "${YELLOW}  Install: mise install gitleaks${NC}"
fi

echo

#
# 2. Hook Tests (existing functionality)
#
HOOKS_SCRIPTS_DIR="${REPO_ROOT}/dot_claude/hooks/scripts"
STAGED_FILES=$(git diff --cached --name-only)

HOOK_FILES_MODIFIED=false
for file in $STAGED_FILES; do
    case "$file" in
        *claude/hooks/*)
            HOOK_FILES_MODIFIED=true
            break
            ;;
    esac
done

if [ "$HOOK_FILES_MODIFIED" = true ] || [ "${FORCE_HOOK_TESTS:-}" = "1" ]; then
    echo -e "${BLUE}üß™ Running hook tests...${NC}"

    FAST_TEST="${HOOKS_SCRIPTS_DIR}/test_fast.sh"
    FULL_TEST="${HOOKS_SCRIPTS_DIR}/run_all_tests.sh"

    if [ -f "$FAST_TEST" ]; then
        TEST_RUNNER="$FAST_TEST"
    elif [ -f "$FULL_TEST" ]; then
        TEST_RUNNER="$FULL_TEST"
    else
        echo -e "${YELLOW}‚ö† No test runner found, skipping${NC}"
        TEST_RUNNER=""
    fi

    if [ -n "$TEST_RUNNER" ]; then
        cd "$HOOKS_SCRIPTS_DIR"
        if ! "$TEST_RUNNER"; then
            echo -e "${RED}‚ùå Hook tests failed!${NC}"
            EXIT_CODE=1
        else
            echo -e "${GREEN}‚úì Hook tests passed${NC}"
        fi
    fi
else
    echo -e "${GREEN}‚úì No hook files modified, skipping tests${NC}"
fi

exit $EXIT_CODE
