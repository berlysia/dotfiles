{{ if ne .chezmoi.os "windows" -}}
#!/bin/bash
# Update ~/.claude/CLAUDE.md when chezmoi template changes
# Hash: {{ includeTemplate "dot_claude/.CLAUDE.md" . | sha256sum }}

set -euo pipefail

TARGET_FILE="$HOME/.claude/CLAUDE.md"
TEMP_FILE=$(mktemp)

# Generate new content from chezmoi template
cat > "$TEMP_FILE" << 'EOF'
{{ includeTemplate "dot_claude/.CLAUDE.md" . }}
EOF

# Create directory if it doesn't exist
mkdir -p "$(dirname "$TARGET_FILE")"

# Check if file exists and compare
if [[ -f "$TARGET_FILE" ]]; then
    if diff -q "$TARGET_FILE" "$TEMP_FILE" >/dev/null 2>&1; then
        echo "No changes to CLAUDE.md"
        rm "$TEMP_FILE"
        exit 0
    fi
    echo "Updating CLAUDE.md..."
else
    echo "Creating new CLAUDE.md..."
fi

# Update file
cp "$TEMP_FILE" "$TARGET_FILE"
rm "$TEMP_FILE"

echo "CLAUDE.md updated successfully"
{{ end -}}