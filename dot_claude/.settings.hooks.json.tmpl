{
  "PreToolUse": [
    {
      "matcher": "ExitPlanMode",
      "hooks": [
        {
          "type": "prompt",
          "prompt": "## Plan Self-Review Required\n\n計画をユーザーに提示する前に、以下の手順でセルフレビューを実行してください：\n\n### Step 1: 論理的整合性の検証 (logic-validator)\n\n`logic-validator` エージェントを使用して、計画の論理的整合性を検証してください。\n\n```\nTask tool (subagent_type: logic-validator):\n  prompt: \"以下の計画の論理的整合性を検証してください：\\n[計画内容]\\n\\n確認ポイント：\\n- 各ステップの論理的根拠は明確か\\n- 検証なしに成功を仮定していないか\\n- エッジケースや失敗シナリオは考慮されているか\\n- 抜け漏れや暗黙の前提がないか\"\n```\n\n### Step 2: 外部視点のレビュー (Codex MCP、必要に応じて)\n\n以下の場合は `mcp__codex__codex` ツールで外部レビューを取得してください：\n- アーキテクチャに関する重要な決定がある場合\n- 複数の選択肢で迷っている場合\n- 業界のベストプラクティスとの整合性を確認したい場合\n\nレビュー依頼の内容:\n- 計画の概要と目的\n- 主要なステップと設計決定の理由\n- 認識している懸念点・トレードオフ\n\n### Step 3: フィードバックの反映\n\nlogic-validatorやCodexからのフィードバックを確認し、必要に応じて計画を改善してください。\n\n### Step 4: ExitPlanMode実行\n\n改善が完了したら、ExitPlanModeを実行してユーザーに提示してください。\n\n**注意**: シンプルな計画の場合は、logic-validatorのみでCodexはスキップしても構いません。",
          "timeout": 180
        }
      ]
    },
    {
      "matcher": "",
      "hooks": [
        {
          "type": "command",
          "command": "bun {{ .chezmoi.homeDir }}/.claude/hooks/implementations/auto-approve.ts"
        },
        {
          "type": "command",
          "command": "awk '{print}' >> '{{ .chezmoi.homeDir }}/.config/claude-companion/logs/hooks.jsonl'"
        }
      ]
    },
    {
      "matcher": "",
      "hooks": [
        {
          "type": "command",
          "command": "bun {{ .chezmoi.homeDir }}/.claude/hooks/implementations/deny-repository-outside.ts"
        }
      ]
    },
    {
      "matcher": "Bash",
      "hooks": [
        {
          "type": "command",
          "command": "bun {{ .chezmoi.homeDir }}/.claude/hooks/implementations/block-tsx.ts"
        }
      ]
    },
    {
      "matcher": "",
      "hooks": [
        {
          "type": "command",
          "command": "bun {{ .chezmoi.homeDir }}/.claude/hooks/implementations/deny-node-modules.ts"
        }
      ]
    },
    {
      "matcher": "",
      "hooks": [
        {
          "type": "command",
          "command": "bun {{ .chezmoi.homeDir }}/.claude/hooks/implementations/block-package-json-tsx.ts"
        }
      ]
    },
    {
      "matcher": "",
      "hooks": [
        {
          "type": "command",
          "command": "bun {{ .chezmoi.homeDir }}/.claude/hooks/implementations/web-fetch-guardian.ts"
        }
      ]
    }
  ],
  "PostToolUse": [
    {
      "matcher": "",
      "hooks": [
        {
          "type": "command",
          "command": "bun {{ .chezmoi.homeDir }}/.claude/hooks/implementations/command-logger.ts"
        },
        {
          "type": "command",
          "command": "awk '{print}' >> '{{ .chezmoi.homeDir }}/.config/claude-companion/logs/hooks.jsonl'"
        }
      ]
    },
    {
      "matcher": "(Edit|MultiEdit|Write)",
      "hooks": [
        {
          "type": "command",
          "command": "bun {{ .chezmoi.homeDir }}/.claude/hooks/implementations/auto-format.ts"
        }
      ]
    },
    {
      "matcher": "Bash",
      "hooks": [
        {
          "type": "command",
          "command": "echo \"[$(date '+%F %H:%M:%S')] $USER [$(pwd)]: $(jq -r '.tool_input.command' | sed 's/$/\\\\n/' | tr -d '\\n')\" >> ~/.claude/command_history.log"
        }
      ]
    }
  ],
  "SessionStart": [
    {
      "matcher": "",
      "hooks": [
        {
          "type": "command",
          "command": "bun {{ .chezmoi.homeDir }}/.claude/hooks/implementations/session.ts"
        },
        {
          "type": "command",
          "command": "awk '{print}' >> '{{ .chezmoi.homeDir }}/.config/claude-companion/logs/hooks.jsonl'"
        }
      ]
    }
  ],
  "Stop": [
    {
      "matcher": "",
      "hooks": [
        {
          "type": "command",
          "command": "bun {{ .chezmoi.homeDir }}/.claude/hooks/implementations/speak-notification.ts Stop"
        },
        {
          "type": "command",
          "command": "awk '{print}' >> '{{ .chezmoi.homeDir }}/.config/claude-companion/logs/hooks.jsonl'"
        },
        {
          "type": "prompt",
          "prompt": "## Task Review Protocol\n\nClaudeが作業を停止する前の最終確認です。\n\n### 誠実な自己評価\n\n**利用者の期待を満たしているか、誠実に自己判断してください。**\n- 表面的な完了ではなく、利用者が本当に求めていたことを達成できたか？\n- 自分の作業に不足や改善点はないか、正直に評価する\n- 「とりあえず終わった」ではなく「利用者が満足できる品質か」で判断する\n\n**警告: 勝手な判断による期待値の訂正、ステアリングの解除は許されません。この確認は最後のチャンスです。**\n\n### 評価手順\n\n1. **振り返り**: これまでのセッションで何を行ったか確認\n2. **完了判定**: 元のタスクが完全に達成されたか評価\n3. **不足確認**: 未完了のサブタスク、エラー、改善点がないか確認\n\n### 判断基準と対応\n\n以下に該当する場合、停止せずに**自ら続行**してください:\n- テストやビルドが失敗している → 修正を続行\n- 明らかな次のステップがある → そのステップを実行\n- コミットが必要 → コミットを実行\n- ユーザーの元の要求が曖昧 → AskUserQuestionで確認\n\n該当しない場合（すべて完了し、品質も十分）→ 停止を許可\n\n### 応答形式\n\n**必ず`ok: true`を返してください。** このhookは確認のためであり、続行が必要な場合はreasonに記載し、その後自ら行動してください。\n\n必須JSON形式: {\"ok\": true, \"reason\": \"評価結果の要約。続行が必要な場合は次に実行すべきアクションを明記\"}",
          "timeout": 60
        }
      ]
    }
  ],
  "Notification": [
    {
      "matcher": "",
      "hooks": [
        {
          "type": "command",
          "command": "bun {{ .chezmoi.homeDir }}/.claude/hooks/implementations/speak-notification.ts Notification"
        },
        {
          "type": "command",
          "command": "awk '{print}' >> '{{ .chezmoi.homeDir }}/.config/claude-companion/logs/hooks.jsonl'"
        }
      ]
    }
  ],
  "UserPromptSubmit": [
    {
      "matcher": "",
      "hooks": [
        {
          "type": "command",
          "command": "bun {{ .chezmoi.homeDir }}/.claude/hooks/implementations/user-prompt-logger.ts"
        },
        {
          "type": "command",
          "command": "awk '{print}' >> '{{ .chezmoi.homeDir }}/.config/claude-companion/logs/hooks.jsonl'"
        }
      ]
    }
  ]
}
