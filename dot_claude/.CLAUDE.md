# Development Guidelines

## Language
- Japanese for discussion, English for code

## Workflow
1. **Explore** - Understand codebase and requirements
2. **Plan** - Design solution with clear steps
3. **Code** - Implement following best practices
4. **Commit** - Clean, meaningful commits

## Development Principles

### Code Quality
- Clean formatting, descriptive names, idiomatic patterns
- **コメント方針**: 
  - **WHYを説明**: コードの理由・背景・制約を記述する。
  - **型システム尊重**: TypeScript型定義から自明な情報はコメントで重複しない
  - **ビジネスロジック重視**: ドメイン知識・設計決定・トレードオフの説明に集中
  - **差分ではなく現状を説明する**: 変更適用後のコードが何をしているかに対して説明する
- Comprehensive error handling and parallelization

### Developer Experience
- Minimize developer friction
- Thorough planning before implementation
- Root cause analysis for bug fixes
- Create scripts for repetitive tasks
- **Decision transparency**: When changing approach mid-task, explicitly explain the reasoning and new plan before proceeding

### Architecture
- **Libraries**: Minimal dependencies, prefer built-ins
- **Design**: Respect existing architecture, maintain unidirectional dependency graph
- **Documentation**: Record significant decisions in ADRs (Architecture Decision Records)
- **Patterns**: Abstract repeated patterns, use tools like `similarity-ts` for detection, `knip` for cleaning

### Testing
- Follow t-wada's TDD style
- Strict Red-Green-Refactor cycle
- Tests must pass before commits

### Debugging
- **Read complete error messages**: Focus on the FIRST error, not the last
  - TypeScript compile errors: first error is usually the root cause
  - Subsequent errors are often cascading failures
  - Use `2>&1 | head -50` or `2>&1 | less`, not just `| tail`

- **Suspect recent changes first**: When something stops working
  - If it worked in Task N and broke in Task N+1, your Task N+1 code is likely wrong
  - Don't modify working configurations without strong evidence
  - Use `git stash` / `git stash pop` to isolate the problem

- **Root cause analysis (5 Whys)**: Avoid symptomatic fixes
  - Bad: "tsc not found" → Change package.json scripts
  - Good: "tsc not found" → Check full error → Find type error → Fix types
  - Ask "why" 5 times to reach root cause
  - Symptomatic fixes create technical debt

- **Incremental debugging**: Step-by-step verification
  1. Capture full error: `command 2>&1 | tee error.log`
  2. Focus on first error message
  3. Form hypothesis about root cause
  4. Verify hypothesis (check files, run tests)
  5. Apply minimal fix
  6. Rebuild/retest with original configuration
  7. Repeat until resolved

- **Protect working configurations**:
  - Don't change build scripts, configs that previously worked
  - If change is necessary, document why original decision was wrong
  - Verify behavior before and after change

- **Use logic-validator proactively**:
  - Before changing working configurations
  - Before applying symptomatic fixes without root cause analysis
  - When assuming without evidence
  - Ask: "Is this reasoning logically sound?"

**Example - TypeScript Build Error**:
```bash
# ❌ Wrong approach
pnpm build 2>&1 | tail -20
# See: "tsc: not found"
# Conclusion: Need to fix package.json scripts

# ✅ Correct approach
pnpm build 2>&1 | head -50
# See: "error TS2307: Cannot find module '@/types'"
# → Root cause: Missing type definitions
# → Fix: Add proper import paths or type declarations
# → Rebuild with original package.json
```

## TypeScript Project Standards
- Package manager: `pnpm`
  - Must use `minimalReleaseAge` with value means 1 week in minutes at least
- Linting: `oxlint`
- Formatting: `prettier`
- Cleaning: `knip`
- Testing for browser: `Vitest`
- Testing for CLI: `node:test`
- No `any` types
- Prefer `async/await`

## Security Requirements
- **Prohibited**: Hardcoded secrets, unvalidated inputs, suppressed errors
- **Required**: Input validation, environment variables, comprehensive logging, passing lint/test

## Git Workflow

### Worktree Management
- **Create**: `git-worktree-create <branch-name>`
  - Location: `.git/worktree/` directory
  - Auto-creates branch from current if needed
  - Uses existing local/remote branches when available
  
- **Cleanup**: `git-worktree-cleanup`
  - Safely removes completed worktrees
  - Preserves worktrees with uncommitted changes or unpushed commits
  - Auto-prunes after deletion

### Commit Standards
- All tests and lints must pass
- Clear, descriptive commit messages
- Use semantic commits with conventional prefixes (feat:, fix:, docs:, etc.)
- Break large changes into logical, atomic commits
- Use `/commit` command for guided semantic commit workflow

## Useful Commands

### Code Analysis
- **similarity-ts**: Detect code duplication
  - `similarity-ts src/`
  - `similarity-ts --threshold 0.8 src/`

### Git Tools
- **git-sequential-stage**: Stage specific hunks for semantic commits
  - `git-sequential-stage -patch="changes.patch" -hunk="file.go:1,3,5"`
  - Used by `/commit` command for precise staging

## Temporal Directory
- If you are in some project, use `${projectRoot}/.tmp` 

## Knowledge Management

### 推奨ドキュメント構造
プロジェクトの `.claude/CLAUDE.md` で定義することを推奨。標準的な構造：
- `.tmp/docs/` - 作業中の一時ファイル（gitignore）
- `docs/decisions/` - Architecture Decision Records (ADR)
- `docs/` - その他の完成したドキュメント

### 記録の原則
- **作業中**: `.tmp/` 配下に配置（gitignore推奨）
- **完成品**: `docs/` 配下に配置（git管理）
- **重要な意思決定**: ADRとして記録

### ドキュメント内リンクの原則
コミット対象の文書（README、docs/配下など）には、以下へのリンクを含めてはならない：
- **gitignoreされたファイル/ディレクトリ**: `.tmp/`、`node_modules/`、ビルド出力など
- **プランファイル**: 一時的な作業計画ファイル
- **ローカル固有のパス**: 絶対パスや環境依存のパス

**対処法**: リンク先の情報が永続的に必要な場合は、`docs/` などgit管理対象の場所に移動してからリンクする。

```
# ❌ Bad: gitignore対象へのリンク
詳細は [設計メモ](.tmp/docs/design-notes.md) を参照

# ✅ Good: git管理対象へのリンク
詳細は [設計メモ](docs/design-notes.md) を参照
```

**Critical Rule:**
Always gather evidence (read files, run tests, check actual state) before making decisions. Use **logic-validator** proactively to catch assumption-based reasoning.

## Codex MCP 活用ガイドライン

OpenAI Codex MCPを活用して、外部視点からのレビューやセカンドオピニオンを取得する。

### 使用すべきタイミング

| 状況 | アクション |
|------|----------|
| **Planモード完了時** | ExitPlanMode実行前に計画をCodexでレビュー |
| **行き詰まり時** | 問題の整理とCodexへの相談で新しい視点を取得 |
| **アーキテクチャ決定** | 選択肢の比較とトレードオフについて意見を求める |
| **デバッグ困難時** | 症状と試したことを整理してCodexに相談 |
| **ユーザーからの明示的依頼** | `/codex-review` で呼び出し |

### 使用方法

```
# 初回の相談
mcp__codex__codex:
  prompt: "レビュー対象の説明"
  cwd: "プロジェクトディレクトリ"（任意）

# 会話の継続
mcp__codex__codex-reply:
  conversationId: "前回のレスポンスから取得"
  prompt: "追加の質問"
```

### ベストプラクティス

1. **十分なコンテキストを提供**: 背景、制約、試したことを明確に
2. **具体的な質問**: 「見落としはないか」「よりシンプルな方法はあるか」
3. **フィードバックの検証**: 提案は参考意見として扱い、最終判断は自分で
4. **機密情報に注意**: センシティブなコードやデータは送信しない