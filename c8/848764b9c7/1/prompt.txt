Implement the following plan:

# è¨ˆç”»: å¤–éƒ¨é€šçŸ¥ã®å…±é€šåŒ– + Slacké€šçŸ¥è¿½åŠ 

## Context

Discordé€šçŸ¥hookã«è“„ç©ã•ã‚ŒãŸã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆStop/PermissionRequest/Notificationåˆ†å²ã€
transcriptæŠ½å‡ºã€permission_prompté‡è¤‡æ’é™¤ã€footeræ§‹ç¯‰ï¼‰ã‚’ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ä¸­ç«‹ãªå…±é€šãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«
æŠ½å‡ºã—ã€Discord/Slackã‚’è–„ã„ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã¨ã—ã¦å®Ÿè£…ã™ã‚‹ã€‚

**å‹•æ©Ÿ**: Slacké€šçŸ¥ã‚’è¿½åŠ ã—ãŸã„ãŒã€ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹ã¨å¤‰æ›´æ™‚ã«2ç®‡æ‰€ä¿®æ­£ãŒå¿…è¦ã«ãªã‚‹ã€‚

## å…±é€šã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹è¨­è¨ˆ

```typescript
// home/dot_claude/hooks/lib/webhook-notification.ts

/** ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ä¸­ç«‹ãªé€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
interface WebhookNotification {
  title: string;        // "âœ… è¿”ä¿¡å®Œäº†", "ğŸ”‘ ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ç¢ºèª", etc.
  description: string;  // transcript summary, tool_name info, etc.
  severity: "success" | "warning" | "info" | "muted";  // color mapping ã¯å„adapterå´
  footer: string;       // "ğŸ“ dotfiles  |  ğŸ”‘ a2f252b"
}

/** ã‚¤ãƒ™ãƒ³ãƒˆå…¥åŠ› â†’ é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¤‰æ›ã€‚null = ã‚¹ã‚­ãƒƒãƒ—ã™ã¹ã */
async function buildNotification(input: HookInput): Promise<WebhookNotification | null>;

/** JSONL transcriptã‹ã‚‰æœ€å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ½å‡ºï¼ˆStopç”¨ï¼‰ */
async function extractFromTranscript(path: string, role: string, limit: number): Promise<string>;
```

## å¤‰æ›´ä¸€è¦§

### Task 1: å…±é€šãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« `webhook-notification.ts` ä½œæˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `home/dot_claude/hooks/lib/webhook-notification.ts` (æ–°è¦)

discord-notification.ts ã‹ã‚‰ä»¥ä¸‹ã‚’æŠ½å‡º:
- `extractFromTranscript()` â€” ãã®ã¾ã¾ç§»å‹•
- `buildNotification(input)` â€” æ–°è¦ã€‚ã‚¤ãƒ™ãƒ³ãƒˆåˆ†å²ãƒ­ã‚¸ãƒƒã‚¯å…¨ä½“ã‚’åŒ…å«:
  - Stop: `stop_hook_active` ãƒã‚§ãƒƒã‚¯ â†’ transcriptæŠ½å‡º â†’ severity: `"success"`
  - PermissionRequest: `tool_name` å–å¾— â†’ severity: `"warning"`
  - Notification: `permission_prompt` ã‚¹ã‚­ãƒƒãƒ—(nullè¿”å´)ã€`idle_prompt` â†’ `"muted"`ã€other â†’ `"info"`
  - footeræ§‹ç¯‰: `getGitContext()` + sessionId
- `WebhookNotification` å‹ã¨ `HookInput` å‹ã‚’export

**å…¥åŠ›å‹ `HookInput`**:
```typescript
interface HookInput {
  hook_event_name: string;
  session_id?: string;
  cwd?: string;
  notification_type?: NotificationType;
  message?: string;
  transcript_path?: string;
  stop_hook_active?: boolean;
  tool_name?: string;
}
```

### Task 2: discord-notification.ts ã‚’ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼åŒ–

**ãƒ•ã‚¡ã‚¤ãƒ«**: `home/dot_claude/hooks/implementations/discord-notification.ts`

- ã‚¤ãƒ™ãƒ³ãƒˆåˆ†å²ãƒ­ã‚¸ãƒƒã‚¯ãƒ»transcriptæŠ½å‡ºãƒ»footeræ§‹ç¯‰ã‚’å‰Šé™¤ã—ã€`buildNotification()` ã‚’å‘¼ã¶ã ã‘ã«
- æ®‹ã‚‹è²¬å‹™: env varãƒã‚§ãƒƒã‚¯ã€`severity â†’ Discord color`ãƒãƒƒãƒ”ãƒ³ã‚°ã€embedæ§‹ç¯‰ã€webhooké€ä¿¡
- `COLORS` ãƒãƒƒãƒ”ãƒ³ã‚°: `successâ†’green`, `warningâ†’orange`, `mutedâ†’grey`, `infoâ†’blue`
- `sendDiscordEmbed()` ã¯ãã®ã¾ã¾æ®‹ã™ï¼ˆDiscord APIå›ºæœ‰ï¼‰

**ãƒªãƒ•ã‚¡ã‚¯ã‚¿å¾Œã®éª¨æ ¼**:
```typescript
const notification = await buildNotification(context.input as HookInput);
if (!notification) return context.success({});

const embed = {
  title: notification.title,
  description: notification.description,
  color: SEVERITY_TO_COLOR[notification.severity],
  ...(notification.footer ? { footer: { text: notification.footer } } : {}),
};
await sendDiscordEmbed(webhookUrl, embed);
```

### Task 3: slack-notification.ts æ–°è¦ä½œæˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `home/dot_claude/hooks/implementations/slack-notification.ts` (æ–°è¦)

- ç’°å¢ƒå¤‰æ•°: `CLAUDE_SLACK_WEBHOOK_URL`ï¼ˆæœªè¨­å®šæ™‚ã¯silent skipï¼‰
- `buildNotification()` ã‚’å‘¼ã³ã€Slack attachmentå½¢å¼ã«å¤‰æ›
- Slack attachment ã¯ Discord embed ã¨æ¦‚å¿µãŒè¿‘ã„ï¼ˆcolor, text, footerï¼‰

**Slack webhook payload**:
```typescript
{
  attachments: [{
    color: SEVERITY_TO_HEX[notification.severity],  // "#2EB67D" etc.
    text: `*${notification.title}*\n${notification.description}`,
    footer: notification.footer,
  }]
}
```

**è‰²ãƒãƒƒãƒ”ãƒ³ã‚°**:
- `success` â†’ `"#2EB67D"` (Slack green)
- `warning` â†’ `"#E0A500"` (Slack orange)
- `muted` â†’ `"#959595"` (grey)
- `info` â†’ `"#36C5F0"` (Slack blue)

**trigger/error handling**: discord-notification.ts ã¨åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã€‚

### Task 4: hooks config æ›´æ–°

**ãƒ•ã‚¡ã‚¤ãƒ«**: `home/dot_claude/.settings.hooks.json.tmpl`

3ã¤ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆStop, Notification, PermissionRequestï¼‰ã«slack-notification.tsã‚’async hookã¨ã—ã¦è¿½åŠ ã€‚discord-notificationã®éš£ã«é…ç½®ã€‚

### Task 5: å…±é€šãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `home/dot_claude/hooks/tests/unit/webhook-notification.test.ts` (æ–°è¦)

- `buildNotification()` ã®å„ã‚¤ãƒ™ãƒ³ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒ†ã‚¹ãƒˆ:
  - Stop â†’ success notification with transcript
  - Stop (stop_hook_active) â†’ null
  - PermissionRequest â†’ warning notification with tool_name
  - Notification (permission_prompt) â†’ null (ã‚¹ã‚­ãƒƒãƒ—)
  - Notification (idle_prompt) â†’ muted notification
  - Notification (other) â†’ info notification
- `extractFromTranscript()` ã®ãƒ†ã‚¹ãƒˆï¼ˆæ—¢å­˜discord testã‹ã‚‰ç§»æ¤å¯èƒ½ï¼‰
- æ—¢å­˜ã® `test-helpers.ts` ã‚’æ´»ç”¨

## å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

| ãƒ•ã‚¡ã‚¤ãƒ« | å¤‰æ›´ |
|---------|------|
| `home/dot_claude/hooks/lib/webhook-notification.ts` | æ–°è¦: å…±é€šã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯ |
| `home/dot_claude/hooks/implementations/discord-notification.ts` | ãƒªãƒ•ã‚¡ã‚¯ã‚¿: è–„ã„ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼åŒ– |
| `home/dot_claude/hooks/implementations/slack-notification.ts` | æ–°è¦: Slackã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ |
| `home/dot_claude/.settings.hooks.json.tmpl` | Slack hookç™»éŒ² |
| `home/dot_claude/hooks/tests/unit/webhook-notification.test.ts` | æ–°è¦: å…±é€šãƒ­ã‚¸ãƒƒã‚¯ã®ãƒ†ã‚¹ãƒˆ |

## å†åˆ©ç”¨ã™ã‚‹æ—¢å­˜æ©Ÿèƒ½

- `hooks/lib/git-context.ts`: `getGitContext()` â€” footeræ§‹ç¯‰ï¼ˆå…±é€šãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ä½¿ç”¨ï¼‰
- `hooks/lib/centralized-logging.ts`: `logEvent()` â€” ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ï¼ˆå„adapterã§ä½¿ç”¨ï¼‰
- `lib/notification-messages.ts`: `NotificationType` å‹

## è¨­è¨ˆåˆ¤æ–­ã®æ ¹æ‹ 

- **footerç”Ÿæˆã‚’å…±é€šãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«å«ã‚ã‚‹ç†ç”±**: Discord embed footerã‚‚Slack attachment footerã‚‚ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã€‚`getGitContext()`ã¯ä¸¡platformå…±é€šã®æƒ…å ±ã§ã‚ã‚Šã€adapterå´ã§é‡è¤‡ã•ã›ã‚‹ç†ç”±ãŒãªã„
- **permission_prompté‡è¤‡æ’é™¤ãŒå…±é€šã«ã‚ã‚‹ç†ç”±**: `PermissionRequest` â†’ `Notification(permission_prompt)` ã¨é †æ¬¡ç™ºç«ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ãƒ­ãƒ¼ï¼ˆå‰å›è¨ˆç”»ã§æ¤œè¨¼æ¸ˆã¿ï¼‰ã€‚ã“ã®æ’é™¤ãƒ­ã‚¸ãƒƒã‚¯ã¯ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å•ã‚ãšå¿…è¦
- **stop_hook_active ã‚¹ã‚­ãƒƒãƒ—**: Claude CodeãŒhookèµ·å› ã®Stopã‚¤ãƒ™ãƒ³ãƒˆã«ä»˜ä¸ã™ã‚‹ãƒ•ãƒ©ã‚°ã€‚é€šçŸ¥hookãŒç„¡é™ãƒ«ãƒ¼ãƒ—ã™ã‚‹ã®ã‚’é˜²ã
- **ã‚¨ãƒ©ãƒ¼æ™‚ context.success({})**: é€šçŸ¥ã¯best-effortã€‚webhookå¤±æ•—ãŒClaude Codeã®ãƒ¡ã‚¤ãƒ³å‡¦ç†ã‚’å¦¨ã’ã¦ã¯ãªã‚‰ãªã„
- **è¤‡æ•°platformåŒæ™‚åˆ©ç”¨**: å„hookã¯ç‹¬ç«‹asyncã§å®Ÿè¡Œã€‚ç‰‡æ–¹ã®å¤±æ•—ã¯ã‚‚ã†ä¸€æ–¹ã«å½±éŸ¿ã—ãªã„

## æ¤œè¨¼æ–¹æ³•

1. **å‹ãƒã‚§ãƒƒã‚¯**: `pnpm typecheck` ãƒ‘ã‚¹
2. **ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ**: `bun test home/dot_claude/hooks/tests/unit/webhook-notification.test.ts` ãƒ‘ã‚¹
3. **æ—¢å­˜ãƒ†ã‚¹ãƒˆå›å¸°**: `bun test home/dot_claude/hooks/tests/unit/` å…¨ãƒ‘ã‚¹
4. **Discordå‹•ä½œç¢ºèª**: æ—¢å­˜å‹•ä½œãŒå¤‰ã‚ã‚‰ãªã„ã“ã¨ã‚’æ‰‹å‹•ç¢ºèª
5. **Slackå‹•ä½œç¢ºèª**: `CLAUDE_SLACK_WEBHOOK_URL` è¨­å®šæ™‚ã«attachmentãŒå±Šãã“ã¨ã‚’ç¢ºèª
6. **chezmoi apply**: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ â†’ settings.json åæ˜ ç¢ºèª

<!-- validated -->


If you need specific details from before exiting plan mode (like exact code snippets, error messages, or content you generated), read the full transcript at: /Users/berlysia/.REDACTED.jsonl

---

ã‚³ãƒŸãƒƒãƒˆã—ã¦