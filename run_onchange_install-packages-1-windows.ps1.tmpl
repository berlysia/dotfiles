{{ if eq .chezmoi.os "windows" }}

# winget package list from packages.yaml
$wingetPackages = @(
{{- range $index, $package := .packages.windows.winget }}
    "{{ $package }}"{{ if ne $index (sub (len $.packages.windows.winget) 1) }},{{ end }}
{{- end }}
)

function Write-Log {
    param([string]$Message, [string]$Level = "INFO")
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    Write-Host "[$timestamp] [$Level] $Message"
}

function Test-WingetAvailable {
    try {
        $null = Get-Command winget -ErrorAction Stop
        return $true
    } catch {
        return $false
    }
}

function Install-WingetPackage {
    param([string]$PackageId)
    
    Write-Log "Installing $PackageId..."
    
    try {
        # Check if package is already installed using winget list query
        Write-Log "Checking if $PackageId is already installed..." "DEBUG"
        $checkResult = winget list --id $PackageId --exact --accept-source-agreements 2>$null
        if ($LASTEXITCODE -eq 0 -and $checkResult -match $PackageId) {
            Write-Log "$PackageId is already installed" "INFO"
            return $true
        }
        
        # Install package with appropriate flags
        Write-Log "Proceeding with installation of $PackageId"
        if ($isAdmin) {
            winget install --id $PackageId --exact --silent --accept-source-agreements --accept-package-agreements --scope machine
        } else {
            winget install --id $PackageId --exact --silent --accept-source-agreements --accept-package-agreements --scope user
        }
        if ($LASTEXITCODE -eq 0) {
            Write-Log "Successfully installed $PackageId" "SUCCESS"
            return $true
        } else {
            Write-Log "Failed to install $PackageId (exit code: $LASTEXITCODE)" "ERROR"
            return $false
        }
    } catch {
        Write-Log "Error installing $PackageId`: $($_.Exception.Message)" "ERROR"
        return $false
    }
}

# Check if running as administrator
$isAdmin = ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator")

# Main installation process
Write-Log "Starting winget package installation..."
if ($isAdmin) {
    Write-Log "Running with administrator privileges - installing system-wide"
} else {
    Write-Log "Running without administrator privileges - installing to user profile"
    Write-Log "Note: Some packages may require administrator privileges and will be skipped"
}

if (-Not (Test-WingetAvailable)) {
    Write-Log "winget is not available. Please install App Installer from Microsoft Store or update Windows." "ERROR"
    exit 1
}

# Update winget sources
Write-Log "Updating winget sources..."
winget source update

$successCount = 0
$failedPackages = @()

foreach ($package in $wingetPackages) {
    if (Install-WingetPackage -PackageId $package) {
        $successCount++
    } else {
        $failedPackages += $package
    }
}

Write-Log "Installation completed. Success: $successCount/$($wingetPackages.Length)"

if ($failedPackages.Length -gt 0) {
    Write-Log "Failed packages:" "ERROR"
    foreach ($pkg in $failedPackages) {
        Write-Log "  - $pkg" "ERROR"
    }
}

{{ end }}
