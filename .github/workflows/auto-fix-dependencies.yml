name: Auto-fix Dependencies

on:
  workflow_run:
    workflows:
      - "Shell Lint (shellcheck)"
      - "TypeScript CI"
      - "Secret Detection (gitleaks)"
      - "Lint GitHub Actions"
      - "Shell Compatibility Test"
      - "Validate Codex Config"
      - "Validate JSON Templates"
    types:
      - completed

concurrency:
  group: auto-fix-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: true

jobs:
  auto-fix:
    # Only run when CI fails on dependency bot PRs
    if: |
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.event == 'pull_request'

    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read

    steps:
      - name: Get PR information
        id: pr-info
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            // Get PR from the workflow_run event
            const prs = context.payload.workflow_run.pull_requests;
            if (!prs || prs.length === 0) {
              core.setFailed('No PR found in workflow_run event');
              return;
            }

            const pr = prs[0];

            // Get full PR details
            const { data: prData } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });

            // Check if PR is from a dependency bot
            const author = prData.user.login;
            const isBot = author === 'renovate[bot]' || author === 'dependabot[bot]';

            if (!isBot) {
              core.info(`Skipping: PR author is ${author}, not a dependency bot`);
              core.setOutput('skip', 'true');
              return;
            }

            core.setOutput('skip', 'false');
            core.setOutput('pr_number', pr.number);
            core.setOutput('head_ref', prData.head.ref);
            core.setOutput('pr_url', prData.html_url);
            core.setOutput('pr_title', prData.title);
            core.setOutput('pr_author', author);

      - name: Checkout repository
        if: steps.pr-info.outputs.skip != 'true'
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0
          ref: ${{ steps.pr-info.outputs.head_ref }}
          persist-credentials: false

      - name: Auto-fix dependencies
        if: steps.pr-info.outputs.skip != 'true'
        id: auto-fix
        uses: anthropics/claude-code-action@ea36d6abdedc17fc2a671b36060770b208a6f8f1 # v1.0.51
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          use_bedrock: false
          use_vertex: false
          prompt: |
            **CI Failed - Fix Required**

            A dependency update PR from ${{ steps.pr-info.outputs.pr_author }} has failed the status check.

            PR: ${{ steps.pr-info.outputs.pr_url }}
            Title: ${{ steps.pr-info.outputs.pr_title }}

            **Your task:**
            1. Check which CI workflows failed: `gh pr checks ${{ steps.pr-info.outputs.pr_number }}`
            2. Investigate failures using `gh run view` and checking test logs
            3. Fix the issues (e.g., update lockfile, resolve conflicts, fix breaking changes)
            4. Commit and push the fixes
            5. DO NOT merge - auto-merge will handle it once all CI checks pass

            **Important:**
            - Focus only on fixing the CI failures
            - After pushing fixes, verify all checks pass with `gh pr checks`
            - Do not manually merge - this repository uses auto-merge for dependency PRs
            - If the issue cannot be fixed automatically, leave a detailed comment explaining the problem

          claude_args: '--allowed-tools "Bash(gh *),Bash(git *),Bash(pnpm *),Bash(npm *),Read,Write,Edit,Glob,Grep"'
