name: Claude Dependency Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  claude-deps-review:
    # Only run for dependency bot PRs
    if: |
      github.event.pull_request.user.login == 'renovate[bot]' ||
      github.event.pull_request.user.login == 'dependabot[bot]'

    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref }}
          persist-credentials: false

      - name: Run Claude Dependency Review
        id: claude-deps
        uses: anthropics/claude-code-action@1b8ee3b94104046d71fde52ec3557651ad8c0d71 # v1.0.29
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          use_bedrock: false
          use_vertex: false
          prompt: |
            This is an automated dependency update PR from ${{ github.event.pull_request.user.login }}.

            PR: ${{ github.event.pull_request.html_url }}
            Title: ${{ github.event.pull_request.title }}

            Please:
            1. Review the dependency changes for any breaking changes or security concerns
            2. If there are lockfile conflicts or issues, resolve them
            3. Run any relevant tests to verify the update works
            4. If everything looks good, approve and merge the PR

            Use `gh pr view`, `gh pr diff`, `gh pr merge` commands as needed.
            If tests fail or there are issues, leave a comment explaining the problem.

          claude_args: '--allowed-tools "Bash(gh:*),Bash(git:*),Bash(pnpm:*),Bash(npm:*),Read,Write,Edit,Glob,Grep"'
