{{ if ne .chezmoi.os "windows" -}}
#!/bin/bash
# Merge chezmoi template changes with existing user settings
# This script is executed BEFORE the file is placed

set -euo pipefail

TARGET_FILE="$HOME/.codex/config.toml"
TEMP_TEMPLATE=$(mktemp)
TEMP_OUTPUT=$(mktemp)

# 1. ツール存在確認（mise経由）
if ! command -v mise &>/dev/null; then
    echo "Error: mise is not installed" >&2
    exit 1
fi

if ! mise list dasel &>/dev/null; then
    echo "Error: dasel is not installed. Run 'mise install dasel'" >&2
    exit 1
fi

# 2. 標準入力からテンプレート内容を取得
cat > "$TEMP_TEMPLATE"

# 3. 既存ファイルが存在しない場合はテンプレートをそのまま出力
if [[ ! -f "$TARGET_FILE" ]]; then
    cat "$TEMP_TEMPLATE"
    rm "$TEMP_TEMPLATE"
    exit 0
fi

# 4. TOML解析チェック
if ! cat "$TARGET_FILE" | mise x -- dasel query --root -i toml -o json >/dev/null 2>&1; then
    # 既存ファイルが不正な場合はテンプレートをそのまま出力
    cat "$TEMP_TEMPLATE"
    rm "$TEMP_TEMPLATE"
    exit 0
fi

# 5. 既存ファイルからユーザー設定セクションを抽出（JSON形式）
EXISTING_PROJECTS_JSON=$(cat "$TARGET_FILE" | mise x -- dasel query 'projects' -i toml -o json 2>/dev/null || echo '{}')
EXISTING_SANDBOX_WS_JSON=$(cat "$TARGET_FILE" | mise x -- dasel query 'sandbox_workspace_write' -i toml -o json 2>/dev/null || echo '{}')
EXISTING_NOTICE_JSON=$(cat "$TARGET_FILE" | mise x -- dasel query 'notice' -i toml -o json 2>/dev/null || echo '{}')

# 6. テンプレートをJSON化
TEMPLATE_JSON=$(cat "$TEMP_TEMPLATE" | mise x -- dasel query --root -i toml -o json)

# 7. jqでマージ（テンプレート + 既存のユーザー設定）
echo "$TEMPLATE_JSON" | jq \
  --argjson projects "$EXISTING_PROJECTS_JSON" \
  --argjson sandbox_ws "$EXISTING_SANDBOX_WS_JSON" \
  --argjson notice "$EXISTING_NOTICE_JSON" \
  '. + {projects: $projects, sandbox_workspace_write: $sandbox_ws, notice: $notice}' \
  | mise x -- dasel query --root -i json -o toml

# 8. クリーンアップ
rm "$TEMP_TEMPLATE"
{{ end -}}
