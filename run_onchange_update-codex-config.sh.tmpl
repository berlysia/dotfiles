{{ if ne .chezmoi.os "windows" -}}
#!/bin/bash
# Update ~/.codex/config.toml by merging chezmoi template changes
# Hash: {{ include "dot_codex/config.toml" | sha256sum }}

set -euo pipefail

TARGET_FILE="$HOME/.codex/config.toml"
TEMP_FILE=$(mktemp)
TEMP_TEMPLATE=$(mktemp)
BACKUP_FILE="${TARGET_FILE}.backup.$(date +%Y%m%d_%H%M%S)"

# 1. ツール存在確認（mise経由）
if ! command -v mise &>/dev/null; then
    echo "Error: mise is not installed"
    exit 1
fi

if ! mise list dasel &>/dev/null; then
    echo "Error: dasel is not installed. Run 'mise install dasel'"
    exit 1
fi

# 2. テンプレートからコア設定を生成
cat > "$TEMP_TEMPLATE" << 'EOF'
{{ include "dot_codex/config.toml" }}
EOF

# 3. 既存ファイルが存在しない場合は新規作成
if [[ ! -f "$TARGET_FILE" ]]; then
    echo "Creating new ~/.codex/config.toml..."
    cp "$TEMP_TEMPLATE" "$TARGET_FILE"
    rm "$TEMP_TEMPLATE"
    echo "~/.codex/config.toml created successfully"
    exit 0
fi

# 4. TOML解析チェック
if ! cat "$TARGET_FILE" | mise x -- dasel query --root -i toml -o json >/dev/null 2>&1; then
    echo "Warning: Existing ~/.codex/config.toml is not valid TOML"
    echo "Creating backup at $BACKUP_FILE"
    cp "$TARGET_FILE" "$BACKUP_FILE"
    echo "Replacing with template content..."
    cp "$TEMP_TEMPLATE" "$TARGET_FILE"
    rm "$TEMP_TEMPLATE"
    echo "~/.codex/config.toml replaced successfully"
    exit 0
fi

# 5. バックアップ作成
cp "$TARGET_FILE" "$BACKUP_FILE"

# 6. 既存ファイルから[projects]セクションを抽出（JSON形式）
EXISTING_PROJECTS_JSON=$(cat "$TARGET_FILE" | mise x -- dasel query 'projects' -i toml -o json 2>/dev/null || echo '{}')

# 7. テンプレートをJSON化
TEMPLATE_JSON=$(cat "$TEMP_TEMPLATE" | mise x -- dasel query --root -i toml -o json)

# 8. jqでマージ（テンプレート + 既存projects）
echo "$TEMPLATE_JSON" | jq --argjson projects "$EXISTING_PROJECTS_JSON" \
  '. + {projects: $projects}' | mise x -- dasel query --root -i json -o toml > "$TEMP_FILE"

rm "$TEMP_TEMPLATE"

# 9. 変更チェックと更新
if diff -q "$TARGET_FILE" "$TEMP_FILE" >/dev/null 2>&1; then
    echo "No changes to ~/.codex/config.toml"
    rm "$TEMP_FILE" "$BACKUP_FILE"
    exit 0
fi

echo "Updating ~/.codex/config.toml..."
mv "$TEMP_FILE" "$TARGET_FILE"
rm "$BACKUP_FILE"
echo "~/.codex/config.toml updated successfully"
{{ end -}}
